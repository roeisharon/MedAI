import { useState, useEffect, useRef } from 'react';

const API = '/api';

const getDir = (text = '') =>
  /[\u0590-\u05ff\u0600-\u06ff]/.test(text) ? 'rtl' : 'ltr';

const parseError = (data) => {
  if (data?.user_message) return { message: data.user_message, code: data.error_code };
  if (data?.detail)       return { message: String(data.detail), code: 'unknown' };
  return { message: 'An unexpected error occurred.', code: 'unknown' };
};


function MetricsPanel() {
  const [metrics, setMetrics] = useState(null);
  const [logs, setLogs]       = useState([]);

  const addLog = (entry) =>
    setLogs(prev => [{ time: new Date().toISOString(), ...entry }, ...prev].slice(0, 50));

  useEffect(() => {
    const fetchMetrics = async () => {
      try {
        const res  = await fetch(`${API}/metrics`);
        const data = await res.json();
        setMetrics(data);
      } catch { /* backend not up yet */ }
    };
    fetchMetrics();
    MetricsPanel.refresh = fetchMetrics;
  }, []);

  MetricsPanel.addLog = addLog;

  const Badge = ({ label, value, danger = false }) => (
    <div className="bg-slate-800 rounded-lg px-3 py-2 min-w-[90px]">
      <div className="text-xs text-slate-400 mb-0.5">{label}</div>
      <div className={`text-lg font-bold ${danger && value > 0 ? 'text-red-400' : 'text-emerald-400'}`}>
        {value ?? 'â€”'}
      </div>
    </div>
  );

  return (
    <div className="bg-slate-900 text-slate-200 rounded-xl p-4 mb-4 border border-slate-700 font-mono text-sm">
      <div className="flex justify-between items-center mb-3">
        <span className="text-sky-400 font-bold">
          ğŸ”­ Observability Panel{' '}
          <span className="text-slate-500 text-xs font-normal">(dev only â€” delete later)</span>
        </span>
        <span className="text-slate-500 text-xs">updates after requests Â· GET /metrics</span>
      </div>

      {metrics ? (
        <>
          <div className="flex flex-wrap gap-2 mb-3">
            <Badge label="Uptime"      value={`${Math.floor(metrics.uptime_seconds / 60)}m`} />
            <Badge label="Requests"    value={metrics.total_requests} />
            <Badge label="Sessions"    value={metrics.total_sessions} />
            <Badge label="LLM Calls"   value={metrics.llm_calls} />
            <Badge label="LLM Errors"  value={metrics.llm_errors} danger />
            <Badge label="Avg Latency" value={metrics.latency_ms?.avg ? `${metrics.latency_ms.avg}ms` : 'â€”'} />
            <Badge label="p95 Latency" value={metrics.latency_ms?.p95 ? `${metrics.latency_ms.p95}ms` : 'â€”'} />
          </div>
          {Object.keys(metrics.errors_by_type || {}).length > 0 && (
            <div className="bg-slate-800 rounded-lg px-3 py-2 mb-3">
              <div className="text-red-400 text-xs mb-1">Errors by type</div>
              {Object.entries(metrics.errors_by_type).map(([k, v]) => (
                <div key={k} className="text-red-300">{k}: <b>{v}</b></div>
              ))}
            </div>
          )}
        </>
      ) : (
        <div className="text-slate-500 mb-3">Waiting for backend...</div>
      )}

      <div className="text-sky-400 text-xs mb-1">Request log (this session)</div>
      <div className="bg-slate-950 rounded-lg p-2.5 max-h-44 overflow-y-auto text-xs leading-relaxed">
        {logs.length === 0
          ? <span className="text-slate-600">No requests yet...</span>
          : logs.map((l, i) => (
            <div key={i} className="border-b border-slate-800 pb-1 mb-1">
              <span className="text-slate-500">{l.time.slice(11, 23)} </span>
              <span className={l.error ? 'text-red-400' : 'text-emerald-400'}>{l.error ? 'âœ—' : 'âœ“'}</span>
              {' '}<span className="text-slate-400">{l.endpoint}</span>
              {l.latency   && <span className="text-sky-400"> {l.latency}ms</span>}
              {l.requestId && <span className="text-slate-500"> req:{l.requestId}</span>}
              {l.error     && <span className="text-red-400"> [{l.error}]</span>}
            </div>
          ))
        }
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CITATION â€” collapsible quote block
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Citation({ citation, index }) {
  const [open, setOpen] = useState(false);
  const dir = getDir(citation.text);

  return (
    <div className="mt-1.5 bg-black/10 rounded-md overflow-hidden text-xs">
      <button
        onClick={() => setOpen(o => !o)}
        className="w-full text-left px-2.5 py-1.5 flex justify-between items-center font-semibold hover:bg-black/10 transition-colors"
      >
        <span>
          ğŸ“ Citation {index + 1}
          {citation.section && <span className="font-normal opacity-75"> â€” {citation.section}</span>}
        </span>
        <span>{open ? 'â–²' : 'â–¼'}</span>
      </button>
      {open && (
        <div className="px-3 pb-2.5 pt-1.5 border-t border-black/10" dir={dir}>
          <p className="italic mb-1">"{citation.text}"</p>
          <p className="opacity-60 text-[11px]">
            {citation.page && `Page ${citation.page}`}
            {citation.page && citation.section && ' Â· '}
            {citation.section && citation.section}
          </p>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ERROR BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ErrorBanner({ error, onClose }) {
  return (
    <div className="flex justify-between items-start bg-red-50 border border-red-200 rounded-lg px-3.5 py-2.5 mt-2.5 text-sm">
      <div>
        <span className="text-red-600 font-bold">âš  Error</span>
        {error.code && (
          <code className="ml-2 bg-red-100 text-red-700 text-[11px] px-1.5 py-0.5 rounded">
            {error.code}
          </code>
        )}
        <p className="text-red-800 mt-1">{error.message}</p>
      </div>
      <button onClick={onClose} className="text-red-400 hover:text-red-600 text-base ml-3 transition-colors">âœ•</button>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export default function App() {
  const [chatId, setChatId]     = useState('');
  const [inputId, setInputId]   = useState('');
  const [messages, setMessages] = useState([]);
  const [input, setInput]       = useState('');
  const [loading, setLoading]   = useState(false);
  const [error, setError]       = useState(null);
  const bottomRef = useRef(null);

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, loading]);

  const loadChat = async (id) => {
    setError(null);
    const t0 = Date.now();
    try {
      const res     = await fetch(`${API}/chats/${id}/messages`);
      const data    = await res.json();
      const latency = Date.now() - t0;
      if (!res.ok) {
        const err = parseError(data);
        setError(err);
        MetricsPanel.addLog?.({ endpoint: `GET /chats/${id}/messages`, error: err.code, latency });
        MetricsPanel.refresh?.();
        return;
      }
      setMessages(data.map(m => ({ role: m.role, content: m.content, citations: m.citations || [] })));
      setChatId(id);
      MetricsPanel.addLog?.({ endpoint: `GET /chats/${id}/messages`, latency });
      MetricsPanel.refresh?.();
    } catch {
      const err = { message: 'Could not reach the backend. Is it running?', code: 'network_error' };
      setError(err);
      MetricsPanel.addLog?.({ endpoint: `GET /chats/${id}/messages`, error: err.code, latency: Date.now() - t0 });
      MetricsPanel.refresh?.();
    }
  };

  const sendMessage = async () => {
    if (!input.trim() || !chatId) return;
    setError(null);
    const userMsg = { role: 'user', content: input, citations: [] };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setLoading(true);
    const t0 = Date.now();
    try {
      const res     = await fetch(`${API}/chats/${chatId}/ask`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: input }),
      });
      const data    = await res.json();
      const latency = Date.now() - t0;
      const reqId   = res.headers.get('X-Request-ID');
      if (!res.ok) {
        const err = parseError(data);
        setError(err);
        setMessages(prev => prev.slice(0, -1));
        MetricsPanel.addLog?.({ endpoint: 'POST /ask', error: err.code, latency, requestId: reqId });
        MetricsPanel.refresh?.();
        return;
      }
      setMessages(prev => [...prev, { role: 'assistant', content: data.answer, citations: data.citations || [] }]);
      MetricsPanel.addLog?.({ endpoint: 'POST /ask', latency, requestId: reqId });
      MetricsPanel.refresh?.();
    } catch {
      const err = { message: 'Could not reach the backend. Is it running?', code: 'network_error' };
      setError(err);
      setMessages(prev => prev.slice(0, -1));
      MetricsPanel.addLog?.({ endpoint: 'POST /ask', error: err.code, latency: Date.now() - t0 });
      MetricsPanel.refresh?.();
    } finally {
      setLoading(false);
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  };

  return (
    <div className="min-h-screen bg-slate-100 p-6">
      <div className="max-w-2xl mx-auto">

        <MetricsPanel />

        {!chatId ? (
          <div className="bg-white rounded-xl shadow-sm p-6">
            <p className="font-semibold mb-1">Step 1</p>
            <p className="text-slate-600 text-sm mb-4">
              Upload a PDF via{' '}
              <a href="http://localhost:8000/docs" target="_blank" rel="noreferrer"
                className="text-blue-500 hover:underline">Swagger UI</a>
              , then paste the <code className="bg-slate-100 px-1 rounded">chat_id</code> below:
            </p>
            <div className="flex gap-2">
              <input
                className="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                placeholder="e.g. 3f2a1b0c-..."
                value={inputId}
                onChange={e => setInputId(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && loadChat(inputId.trim())}
              />
              <button
                onClick={() => loadChat(inputId.trim())}
                className="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 rounded-lg text-sm transition-colors"
              >
                Load Chat
              </button>
            </div>
            {error && <ErrorBanner error={error} onClose={() => setError(null)} />}
          </div>

        ) : (
          <>
            <div className="bg-white rounded-xl shadow-sm px-4 py-3 mb-3 flex justify-between items-center">
              <div>
                <span className="font-semibold">Chat active</span>
                <code className="ml-2 text-slate-400 text-xs">{chatId}</code>
              </div>
              <button
                onClick={() => { setChatId(''); setMessages([]); setInputId(''); }}
                className="text-sm border border-slate-200 rounded-lg px-3 py-1 hover:bg-slate-50 transition-colors"
              >
                Switch chat
              </button>
            </div>

            <div className="bg-white rounded-xl shadow-sm p-4 mb-3 min-h-[300px] max-h-[520px] overflow-y-auto">
              {messages.length === 0 && (
                <p className="text-slate-400 text-center mt-16 text-sm">
                  No messages yet. Ask something about the leaflet.
                </p>
              )}

              {messages.map((msg, idx) => {
                const isUser = msg.role === 'user';
                const dir    = getDir(msg.content);
                return (
                  <div key={idx} className={`flex mb-3 ${isUser ? 'justify-end' : 'justify-start'}`}>
                    <div
                      dir={dir}
                      className={`max-w-[80%] px-3.5 py-2.5 text-sm leading-relaxed
                        ${isUser
                          ? 'bg-blue-500 text-white rounded-2xl rounded-br-sm'
                          : 'bg-slate-100 text-slate-800 rounded-2xl rounded-bl-sm'}`}
                    >
                      {msg.content}
                      {msg.citations?.length > 0 && (
                        <div className="mt-2">
                          {msg.citations.map((c, i) => <Citation key={i} citation={c} index={i} />)}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}

              {loading && (
                <div className="flex justify-start mb-3">
                  <div className="bg-slate-100 text-slate-400 rounded-2xl rounded-bl-sm px-3.5 py-2.5 text-sm">
                    Thinking...
                  </div>
                </div>
              )}
              <div ref={bottomRef} />
            </div>

            {error && <ErrorBanner error={error} onClose={() => setError(null)} />}

            <div className="flex gap-2">
              <input
                className="flex-1 border border-slate-300 rounded-xl px-3.5 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                value={input}
                onChange={e => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Ask a question about the leaflet..."
                disabled={loading}
              />
              <button
                onClick={sendMessage}
                disabled={loading || !input.trim()}
                className="bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white font-semibold px-5 rounded-xl text-sm transition-colors disabled:cursor-not-allowed"
              >
                Send
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}